name: Deploy to Azure Blob Static Website

on:
  push:
    branches: [ main ]
    paths:             # deploy only when site files change
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - 'img/**'
      - 'data/**'
      - '!**/*.md'
  workflow_dispatch:   # manual run button

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-azure
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # --- Option A: login with secret JSON (what you have now) ---
      - name: Azure login (service principal)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- Option B: login via OIDC (preferred; no long-lived secret) ---
      #   To use this, set AZURE_CLIENT_ID and AZURE_TENANT_ID repo secrets and
      #   add a federated credential to your app registration for this repo/branch.
      - name: Azure login (OIDC)
        if: ${{ secrets.AZURE_CREDENTIALS == '' }}
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set subscription
        uses: azure/CLI@v2
        with:
          inlineScript: az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Create $web if missing (idempotent)
      - name: Ensure $web container exists (AAD)
        uses: azure/CLI@v2
        env:
          ACC: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
        with:
          inlineScript: |
            set -e
            ACC_TRIM=$(echo -n "$ACC" | tr -d '\r\n ')
            az storage container create \
              --account-name "$ACC_TRIM" \
              --auth-mode login \
              --name '$web' \
              --public-access off

      # Upload site (excludes .git and workflows)
      - name: Upload site to $web (AAD)
        uses: azure/CLI@v2
        env:
          ACC: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
        with:
          inlineScript: |
            set -e
            ACC_TRIM=$(echo -n "$ACC" | tr -d '\r\n ')
            az storage blob upload-batch \
              --account-name "$ACC_TRIM" \
              --auth-mode login \
              --destination '$web' \
              --source . \
              --overwrite \
              --no-progress \
              --pattern '!**/.git*' \
              --pattern '!**/.github/**'

      # Proof
      - name: List uploaded files (proof)
        uses: azure/CLI@v2
        env:
          ACC: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
        with:
          inlineScript: |
            ACC_TRIM=$(echo -n "$ACC" | tr -d '\r\n ')
            az storage blob list \
              --account-name "$ACC_TRIM" \
              --auth-mode login \
              --container-name '$web' \
              --num-results 50 \
              --query "[].{name:name, modified:properties.lastModified}" -o table
